<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <!-- âœ… ëª¨ë°”ì¼ ëŒ€ì‘ì„ ìœ„í•œ viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>{{ title if title else "ì—°êµ¬ë…¸íŠ¸ ë·°ì–´" }}</title>

  <!-- âœ… FastAPI StaticFiles: /research/static/style.css -->
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">

  <style>
    /* =========================
       âœ… ì „ì—­ í°íŠ¸ ì„¤ì •
       - 1ìˆœìœ„: Microsoft NeoGothic
       - ì—†ìœ¼ë©´ fallbackìœ¼ë¡œ ë‚´ë ¤ê°
       ========================= */
    :root{
      --app-font: "Microsoft NeoGothic", "Microsoft Neogothic",
                  "Malgun Gothic", "ë§‘ì€ ê³ ë”•",
                  "Apple SD Gothic Neo",
                  "Noto Sans KR",
                  "Segoe UI",
                  Arial, sans-serif;
    }

    html, body{
      font-family: var(--app-font);
      font-size: 16px;
      line-height: 1.5;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
      html, body,
  .header, .main, .main-inner,
  .viewer-layout, .viewer-main, .viewer-sidebar,
  .markdown-body,
  .project-card, .detail-header,
  button, input, textarea, select {
    font-family: var(--app-font) !important;
  }

  /* ì½”ë“œë¸”ë¡ì€ ê°€ë…ì„± ìœ„í•´ monospace ìœ ì§€(ì›í•˜ë©´ ì‚­ì œ ê°€ëŠ¥) */
  pre, code, kbd, samp {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  }
    /* âœ… form ìš”ì†Œ/ë²„íŠ¼ë„ í°íŠ¸ ìƒì† ë³´ì¥ */
    input, button, textarea, select{
      font: inherit;
    }

    /* ìµœì†Œ ë‹¤í¬ëª¨ë“œ override */
    body.dark {
      background: #111;
      color: #eee;
    }
    body.dark a {
      color: #9cd;
    }
    body.dark .header {
      background: #000;
    }
    body.dark .project-card {
      background: #222;
      border-color: #444;
    }

    .header-nav {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 0.9rem;
      flex-wrap: wrap; /* ëª¨ë°”ì¼ì—ì„œ ìë™ ì¤„ë°”ê¿ˆ */
    }
    .header-nav a {
      text-decoration: none;
    }
    #theme-toggle {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1.1rem;
    }
    .header-user {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    /* í”„ë¦¬ë·° ì»¤ì„œ ìœ„ì¹˜ ë§ˆì»¤ (ëˆˆì—ëŠ” ì•ˆ ë³´ì´ê²Œ) */
    #__cursor_marker__ {
      display: block;
      height: 0;
      margin: 0;
      padding: 0;
      border: 0;
    }

    /* í—¤ë” ë ˆì´ì•„ì›ƒ: ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œ ì •ë ¬ */
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 12px;
      box-sizing: border-box;
    }

    .logo a {
      text-decoration: none;
      color: inherit;
      font-size: 1.1rem;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-nav {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>

<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<body>
  <!-- <div style="position:fixed;top:8px;right:8px;z-index:99999;background:#ff1744;color:#fff;padding:6px 10px;border-radius:8px;font-weight:800;">
  viewer v-TEST
</div> -->
  <header class="header">
    <div class="header-inner">
      <h1 class="logo">
        <a href="{{ url_for('index') }}">ì—°êµ¬ë…¸íŠ¸ ë·°ì–´</a>
      </h1>

      <nav class="header-nav">
        <a href="{{ url_for('global_search') }}">ğŸ” ì „ì—­ ê²€ìƒ‰</a>
        <a href="{{ url_for('tasks_view') }}">âœ… í•  ì¼</a>
        <a href="{{ url_for('debug_log') }}">ğŸ“œ ë¡œê·¸</a>

        {# âœ… ì„¸ì…˜ ë¯¸ë“¤ì›¨ì–´ê°€ ì—†ê±°ë‚˜ session í‚¤ê°€ ì—†ì„ ë•Œë„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ #}
        {% if 'session' in request.scope and request.scope['session'].get('user') %}
          <span class="header-user">
            ë¡œê·¸ì¸: {{ request.scope['session'].get('user') }}
          </span>
          <a href="{{ url_for('logout') }}" class="top-nav-link">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
        {% else %}
          <a href="{{ url_for('login_page') }}" class="top-nav-link">ë¡œê·¸ì¸</a>
        {% endif %}

        <button id="theme-toggle" title="ë¼ì´íŠ¸/ë‹¤í¬ ì „í™˜">ğŸŒ™</button>
      </nav>
    </div>
  </header>

  <main class="main">
    <!-- âœ… ëª¨ë°”ì¼/PC ê³µí†µ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ -->
    <div class="main-inner">
      {% block content %}{% endblock %}
    </div>
  </main>

  <script>
    // ë‹¤í¬ ëª¨ë“œ í† ê¸€
    (function() {
      const body = document.body;
      const btn = document.getElementById('theme-toggle');
      const saved = localStorage.getItem('nv_theme') || 'light';
      if (saved === 'dark') {
        body.classList.add('dark');
        if (btn) btn.textContent = 'â˜€ï¸';
      }
      if (btn) {
        btn.addEventListener('click', function() {
          const isDark = body.classList.toggle('dark');
          localStorage.setItem('nv_theme', isDark ? 'dark' : 'light');
          btn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        });
      }
    })();

    // ì—ë””í„° í˜ì´ì§€ ë‹¨ì¶•í‚¤: Ctrl+S â†’ ì €ì¥
    (function() {
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
          const form = document.querySelector('form.editor-form');
          if (form) {
            e.preventDefault();
            form.submit();
          }
        }
      });
    })();
  </script>
</body>
</html>
{% extends "base.html" %}
{% block content %}

<h2>ì„œë²„ ë¡œê·¸ (ìµœê·¼ {{ lines }}ì¤„)</h2>

<p class="meta">
  ê°œë°œìš© ë‚´ë¶€ í˜ì´ì§€ì…ë‹ˆë‹¤. ë¡œì»¬ì—ì„œë§Œ ë³´ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
</p>

<pre class="log-view">
{{ log_text }}
</pre>

{% endblock %}
{% extends "base.html" %}

{% block extra_head %}
  {% if image_base_dir %}
    <base href="{{ url_for('serve_media', rel_path=image_base_dir) }}/">
  {% endif %}
{% endblock %}

{% block content %}

<div class="project-header"
     style="--accent-color: {{ theme.accent }}; flex-wrap: wrap; gap: 8px;">
  <div>
    <h2>ë¬¸ì„œ í¸ì§‘: {{ file_name }}</h2>
    <p class="meta">ê²½ë¡œ: {{ rel_path }}</p>
  </div>
  <div class="project-header-actions"
       style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end;">
    <a class="btn-secondary"
       href="{{ url_for('view_file') }}?rel_path={{ rel_path }}">
      â† ìƒì„¸ë³´ê¸°ë¡œ
    </a>
  </div>
</div>

<form method="post"
      action="{{ url_for('save_file') }}"
      class="editor-form">
  <input type="hidden" name="rel_path" value="{{ rel_path }}">

  <div class="editor-wrapper editor-split">
    <!-- ì™¼ìª½: ì—ë””í„° -->
    <div class="editor-pane">
      <label for="editor" class="meta">Markdown ë‚´ìš©</label>
      <textarea id="editor"
                name="content"
                class="editor-textarea"
                spellcheck="false">{{ raw_content }}</textarea>
      <p class="meta">
        â— í…ìŠ¤íŠ¸ ì˜ì—­ì„ í´ë¦­í•œ ë’¤ ì´ë¯¸ì§€ í´ë¦½ë³´ë“œ(Ctrl+V) ë¶™ì—¬ë„£ê¸° â†’  
        ì„œë²„ì— ì—…ë¡œë“œ í›„ <code>![...](...)</code> ë§í¬ ìë™ ì‚½ì…<br>
        â— í”„ë¡œì íŠ¸ ê¸°ì¤€ ì´ë¯¸ì§€ í´ë”: <code>{{ image_base_dir }}</code>
      </p>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ë¯¸ë¦¬ë³´ê¸° -->
    <div class="preview-pane">
      <div class="preview-header">ë¼ì´ë¸Œ ë¯¸ë¦¬ë³´ê¸°</div>
      <div id="preview" class="preview-body markdown-body"></div>
    </div>
  </div>

  <div class="editor-actions">
    <button type="submit" class="btn">ì €ì¥</button>
    <button type="button" class="btn-secondary" onclick="window.history.back()">ì·¨ì†Œ</button>
  </div>
</form>

<script>
  const editor = document.getElementById('editor');
  const imageBaseDir = "{{ image_base_dir }}";
  const uploadUrl = "{{ url_for('upload_image') }}";
  const previewUrl = "{{ url_for('render_preview') }}";
  const preview = document.getElementById('preview');

  const log = (...args) => console.log("[EDIT]", ...args);

  function insertAtCursor(textarea, text) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const value = textarea.value;
    textarea.value = value.substring(0, start) + text + value.substring(end);
    const pos = start + text.length;
    textarea.selectionStart = textarea.selectionEnd = pos;
    textarea.focus();
  }

  function schedulePreviewUpdate() {
    if (!preview || !editor) return;

    if (window.__previewTimer) {
      clearTimeout(window.__previewTimer);
    }
    window.__previewTimer = setTimeout(() => {
      const formData = new FormData();

      const value = editor.value;
      const caretPos = editor.selectionStart || 0;
      const marker = "\n\n<div id=\"__cursor_marker__\"></div>\n\n";
      const withMarker = value.slice(0, caretPos) + marker + value.slice(caretPos);

      formData.append('content', withMarker);

      const prevScrollTop = preview.scrollTop;
      const prevMax = Math.max(1, preview.scrollHeight - preview.clientHeight);
      const prevRatio = prevScrollTop / prevMax;

      fetch(previewUrl, {
        method: 'POST',
        body: formData
      })
      .then(res => res.text())
      .then(html => {
        preview.innerHTML = html;

        // âœ… MathJax ì¬ë Œë”
        if (window.MathJax && MathJax.typesetPromise) {
          MathJax.typesetPromise([preview]).catch(err => console.error('MathJax typeset error', err));
        }

        const markerEl = preview.querySelector('#__cursor_marker__');
        if (markerEl) {
          markerEl.scrollIntoView({ block: 'center' });
        } else {
          const max = Math.max(1, preview.scrollHeight - preview.clientHeight);
          preview.scrollTop = max * prevRatio;
        }
      })
      .catch(err => {
        console.error('preview error', err);
      });
    }, 200);
  }

  editor.addEventListener('input', schedulePreviewUpdate);
  editor.addEventListener('click', schedulePreviewUpdate);
  editor.addEventListener('keyup', schedulePreviewUpdate);
  window.addEventListener('load', schedulePreviewUpdate);

  // =========================
  // âœ… viewerì˜ "ì—¬ê¸°ë¶€í„° ìˆ˜ì •" ì§€ì›
  // - focus=1&snippet=...&start=...
  // =========================
  function escapeRegExp(s) {
    return (s || "").replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function findAllOccurrences(haystack, needle) {
    const out = [];
    if (!needle) return out;
    let idx = 0;
    while (true) {
      const i = haystack.indexOf(needle, idx);
      if (i === -1) break;
      out.push(i);
      idx = i + Math.max(1, needle.length);
    }
    return out;
  }

  function findBestIndexInMarkdown(md, snippet, startHint) {
    const text = (snippet || "").trim();
    if (!text) return 0;

    // 1) exact match
    const hits = findAllOccurrences(md, text);
    if (hits.length === 1) return hits[0];
    if (hits.length > 1) {
      if (Number.isFinite(startHint)) {
        let best = hits[0];
        let bestDist = Math.abs(best - startHint);
        for (const h of hits) {
          const d = Math.abs(h - startHint);
          if (d < bestDist) { bestDist = d; best = h; }
        }
        return best;
      }
      return hits[0];
    }

    // 2) case-insensitive exact
    const lowMd = md.toLowerCase();
    const lowNeedle = text.toLowerCase();
    const hits2 = findAllOccurrences(lowMd, lowNeedle);
    if (hits2.length) {
      if (Number.isFinite(startHint) && hits2.length > 1) {
        let best = hits2[0];
        let bestDist = Math.abs(best - startHint);
        for (const h of hits2) {
          const d = Math.abs(h - startHint);
          if (d < bestDist) { bestDist = d; best = h; }
        }
        return best;
      }
      return hits2[0];
    }

    // 3) token order regex (whitespace/linebreak/ë§ˆí¬ë‹¤ìš´ ë¼ì–´ë„ ì–´ëŠ ì •ë„ ëŒ€ì‘)
    const tokens = text.split(/\s+/).filter(Boolean).slice(0, 10);
    if (tokens.length >= 2) {
      const pattern = tokens.map(t => escapeRegExp(t)).join("[\\s\\S]{0,80}");
      try {
        const re = new RegExp(pattern, "i");
        const m = re.exec(md);
        if (m && typeof m.index === "number") return m.index;
      } catch(e) {}
    }

    // 4) fallback: ì•ë¶€ë¶„ ì¼ë¶€ë¼ë„
    const head = text.slice(0, Math.min(30, text.length));
    const i3 = md.indexOf(head);
    if (i3 >= 0) return i3;

    return 0;
  }

  function scrollEditorToPos(textarea, pos) {
    try {
      const before = textarea.value.slice(0, pos);
      const line = (before.match(/\n/g) || []).length + 1;
      const cs = getComputedStyle(textarea);
      const lh = parseFloat(cs.lineHeight) || 18;
      const targetTop = Math.max(0, (line - 6) * lh);
      textarea.scrollTop = targetTop;
    } catch(e) {}
  }

  (function applyFocusFromQuery(){
    try{
      const params = new URLSearchParams(window.location.search);
      const focus = params.get("focus");
      if (focus !== "1") return;

      const snippet = (params.get("snippet") || "").trim();
      const startHintRaw = params.get("start");
      const startHint = startHintRaw !== null ? parseInt(startHintRaw, 10) : NaN;

      const md = editor.value || "";
      const pos = findBestIndexInMarkdown(md, snippet, startHint);

      log("focus request:", { snippet: snippet.slice(0, 80), startHint, pos });

      editor.focus();
      editor.setSelectionRange(pos, pos);
      scrollEditorToPos(editor, pos);

      // ì»¤ì„œ ë°˜ì˜ëœ ìƒíƒœë¡œ í”„ë¦¬ë·°ë„ ê°±ì‹ (ë§ˆì»¤ ì´ë™)
      schedulePreviewUpdate();
    }catch(e){
      console.warn("applyFocusFromQuery failed", e);
    }
  })();

  // =========================
  // ì´ë¯¸ì§€ í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° â†’ ì—…ë¡œë“œ + ë§ˆí¬ë‹¤ìš´ ì‚½ì…
  // =========================
  editor.addEventListener('paste', function (e) {
    const items = (e.clipboardData || e.originalEvent?.clipboardData)?.items;
    if (!items) return;

    for (const item of items) {
      if (item.type && item.type.indexOf('image') !== -1) {
        e.preventDefault();
        const file = item.getAsFile();
        if (!file) return;

        const formData = new FormData();
        formData.append('base_rel_dir', imageBaseDir);
        formData.append('image', file);

        fetch(uploadUrl, {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok && data.md_path) {
            const md = `![pasted image](${data.md_path})\n`;
            insertAtCursor(editor, md);
            schedulePreviewUpdate();
          } else {
            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(err => {
          console.error(err);
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });

        break;
      }
    }
  });
</script>

{% endblock %}
{% extends "base.html" %}
{% block content %}

<section class="index-header">
  <h2>í”„ë¡œì íŠ¸ ëª©ë¡</h2>
</section>

{% if projects %}

  <div class="project-toolbar"
       style="margin-bottom: 8px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
    <button type="button" class="btn-small" id="reorder-toggle">
      ğŸ”§ ì •ë ¬ í¸ì§‘
    </button>
    <button type="button" class="btn-small" id="reorder-save" style="display: none;">
      ğŸ’¾ ìˆœì„œ ì €ì¥
    </button>
    <span class="meta" id="reorder-help" style="margin-left: 6px; display: none;">
      ì¹´ë“œë¥¼ ë“œë˜ê·¸í•´ì„œ ìˆœì„œë¥¼ ë°”ê¾¼ ë’¤, <strong>ìˆœì„œ ì €ì¥</strong>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
    </span>
  </div>

  <div class="project-list" id="project-list">
    {% for proj in projects %}
      <a class="project-card"
         data-rel-path="{{ proj.rel_path }}"
         href="{{ url_for('project_view') }}?rel_path={{ proj.rel_path }}"
         style="
           --card-bg: {{ proj.theme.card_bg }};
           --card-border: {{ proj.theme.card_border }};
           --accent-color: {{ proj.theme.accent }};
         ">
        <div class="project-name">{{ proj.name }}</div>
        <div class="project-path">{{ proj.rel_path }}</div>
      </a>
    {% endfor %}
  </div>

{% else %}
  <p>í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ROOT_DIR ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
{% endif %}

<hr>

<div class="dashboard-sections">
  <section class="dashboard-section">
    <h3>ìµœê·¼ ì—´ì–´ë³¸ ë…¸íŠ¸</h3>
    {% if recent_notes %}
      <ul class="note-list">
        {% for note in recent_notes %}
          <li>
            <a href="{{ url_for('view_file') }}?rel_path={{ note.rel_path }}">
              {{ note.name }}
            </a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>ìµœê·¼ ì—´ëŒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </section>

  <section class="dashboard-section">
    <h3>ì¦ê²¨ì°¾ê¸°</h3>
    {% if favorite_notes %}
      <ul class="note-list">
        {% for note in favorite_notes %}
          <li>
            <a href="{{ url_for('view_file') }}?rel_path={{ note.rel_path }}">
              {{ note.name }}
            </a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>ì¦ê²¨ì°¾ê¸°ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </section>
</div>

<script>
  (function () {
    const projectList   = document.getElementById('project-list');
    const toggleBtn     = document.getElementById('reorder-toggle');
    const saveBtn       = document.getElementById('reorder-save');
    const helpText      = document.getElementById('reorder-help');
    const saveOrderUrl  = "{{ url_for('save_project_order') }}";

    if (!projectList || !toggleBtn || !saveBtn) return;

    let isReorderMode = false;
    let draggingEl = null;

    function setReorderMode(on) {
      isReorderMode = on;
      const cards = projectList.querySelectorAll('.project-card');
      cards.forEach(card => {
        card.draggable = on;
        card.classList.toggle('reorder-mode', on);
      });
      saveBtn.style.display = on ? 'inline-flex' : 'none';
      helpText.style.display = on ? 'inline' : 'none';
      toggleBtn.textContent = on ? 'âœ… ì •ë ¬ í¸ì§‘ ì¢…ë£Œ' : 'ğŸ”§ ì •ë ¬ í¸ì§‘';
    }

    toggleBtn.addEventListener('click', () => {
      setReorderMode(!isReorderMode);
    });

    projectList.addEventListener('click', (e) => {
      if (!isReorderMode) return;
      const a = e.target.closest('.project-card');
      if (a) {
        e.preventDefault();
      }
    });

    projectList.addEventListener('dragstart', (e) => {
      if (!isReorderMode) return;
      const card = e.target.closest('.project-card');
      if (!card) return;
      draggingEl = card;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', card.dataset.relPath || '');
    });

    projectList.addEventListener('dragend', (e) => {
      const card = e.target.closest('.project-card');
      if (card) {
        card.classList.remove('dragging');
      }
      draggingEl = null;
    });

    projectList.addEventListener('dragover', (e) => {
      if (!isReorderMode || !draggingEl) return;
      e.preventDefault();
      const afterElement = getDragAfterElement(projectList, e.clientY);
      if (!afterElement) {
        projectList.appendChild(draggingEl);
      } else {
        projectList.insertBefore(draggingEl, afterElement);
      }
    });

    function getDragAfterElement(container, y) {
      const cards = [...container.querySelectorAll('.project-card:not(.dragging)')];
      let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

      for (const card of cards) {
        const box = card.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          closest = { offset, element: card };
        }
      }
      return closest.element;
    }

    saveBtn.addEventListener('click', () => {
      const cards = [...projectList.querySelectorAll('.project-card')];
      const order = cards.map(c => c.dataset.relPath);

      fetch(saveOrderUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ order })
      })
      .then(res => res.json())
      .then(data => {
        if (data && data.ok) {
          alert('í”„ë¡œì íŠ¸ ìˆœì„œë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
          setReorderMode(false);
        } else {
          alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(err => {
        console.error(err);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    });
  })();
</script>

{% endblock %}
{% extends "base.html" %}
{% block content %}

<div class="login-container"
     style="max-width: 360px; margin: 72px auto 40px; padding: 16px; border-radius: 8px;
            background-color: var(--card-bg); border: 1px solid var(--card-border);">
  <h2 style="margin-top: 0; margin-bottom: 8px;">ë¡œê·¸ì¸</h2>
  <p class="meta" style="margin-bottom: 12px;">
    ì´ ë·°ì–´ëŠ” ë³´í˜¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤. <code>config.json</code> ì— ì„¤ì •í•œ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.
  </p>

  {% if error %}
    <div style="color: #c33; margin-bottom: 8px; font-size: 0.9rem;">
      {{ error }}
    </div>
  {% endif %}

  <form method="post"
        action="{{ url_for('login_submit') }}"
        class="login-form">
    <div class="settings-row" style="margin-bottom: 8px;">
      <label for="username">ì•„ì´ë””</label>
      <input id="username"
             type="text"
             name="username"
             autocomplete="username"
             style="width: 100%; padding: 6px 8px; box-sizing: border-box;">
    </div>

    <div class="settings-row" style="margin-bottom: 12px;">
      <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
      <input id="password"
             type="password"
             name="password"
             autocomplete="current-password"
             style="width: 100%; padding: 6px 8px; box-sizing: border-box;">
    </div>

    <div class="settings-actions" style="margin-top: 12px;">
      <button type="submit" class="btn" style="width: 100%;">ë¡œê·¸ì¸</button>
    </div>
  </form>
</div>

<script>
  (function () {
    const idInput = document.getElementById('username');
    if (idInput) {
      idInput.focus();
    }
  })();
</script>

{% endblock %}
{% extends "base.html" %}

{% block extra_head %}
  {% if project_rel_path %}
    <base href="{{ url_for('serve_media', rel_path=project_rel_path) }}/">
  {% endif %}
{% endblock %}

{% block content %}

<div class="project-header"
     style="--accent-color: {{ theme.accent }}; flex-wrap: wrap; gap: 8px;">
  <div>
    <h2>ìƒˆ ë¬¸ì„œ ìƒì„± ({{ project_name }})</h2>
    <p class="meta">í”„ë¡œì íŠ¸ ê²½ë¡œ: {{ project_rel_path }}</p>
  </div>
  <div class="project-header-actions"
       style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end;">
    <a class="btn-secondary"
       href="{{ url_for('project_view') }}?rel_path={{ project_rel_path }}">
      â† í”„ë¡œì íŠ¸ ëª©ë¡ìœ¼ë¡œ
    </a>
  </div>
</div>

<form method="post"
      action="{{ url_for('new_file') }}"
      class="editor-form">
  <input type="hidden" name="project_rel_path" value="{{ project_rel_path }}">

  <div class="settings-row" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px;">
    <label for="title" style="min-width: 80px;">íŒŒì¼ ì œëª©</label>
    <input id="title"
           type="text"
           name="title"
           placeholder="ì˜ˆ: 20251211.ë…¼ë¬¸ë¦¬ë·°.Ab Initio Force Fields..."
           style="flex: 1 1 200px; padding: 4px 8px;">
  </div>

  <div class="settings-row" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px;">
    <label for="template_name" style="min-width: 80px;">í…œí”Œë¦¿</label>
    <select id="template_name" name="template_name">
      <option value="">(ë¹ˆ ë¬¸ì„œ)</option>
      {% for t in available_templates %}
        <option value="{{ t }}">{{ t }}</option>
      {% endfor %}
    </select>
    <span class="meta">note_templates í´ë”ì˜ .md íŒŒì¼</span>
  </div>

  <div class="editor-wrapper editor-split">
    <!-- ì™¼ìª½: ì—ë””í„° -->
    <div class="editor-pane">
      <label for="new-editor" class="meta">Markdown ë‚´ìš©</label>
      <textarea id="new-editor"
                name="content"
                class="editor-textarea"
                spellcheck="false"></textarea>
      <p class="meta">
        â— í…ìŠ¤íŠ¸ ì˜ì—­ì—ì„œ Ctrl+Vë¡œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° â†’  
        <code>{{ project_rel_path }}/_images</code> í´ë”ì— ì €ì¥ +  
        <code>![...](...)</code> ìë™ ì‚½ì…
      </p>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ë¯¸ë¦¬ë³´ê¸° -->
    <div class="preview-pane">
      <div class="preview-header">ë¼ì´ë¸Œ ë¯¸ë¦¬ë³´ê¸°</div>
      <div id="new-preview" class="preview-body markdown-body"></div>
    </div>
  </div>

  <div class="editor-actions">
    <button type="submit" class="btn">ìƒì„±</button>
    <button type="button" class="btn-secondary" onclick="window.history.back()">ì·¨ì†Œ</button>
  </div>
</form>

<script>
  const newEditor = document.getElementById('new-editor');
  const imageBaseDirNew = "{{ project_rel_path }}";
  const uploadUrlNew = "{{ url_for('upload_image') }}";
  const previewUrlNew = "{{ url_for('render_preview') }}";
  const newPreview = document.getElementById('new-preview');

  function insertAtCursorNew(textarea, text) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const value = textarea.value;
    textarea.value = value.substring(0, start) + text + value.substring(end);
    const pos = start + text.length;
    textarea.selectionStart = textarea.selectionEnd = pos;
    textarea.focus();
  }
  function schedulePreviewUpdateNew() {
    if (!newPreview || !newEditor) return;

    if (window.__newPreviewTimer) {
      clearTimeout(window.__newPreviewTimer);
    }
    window.__newPreviewTimer = setTimeout(() => {
      const formData = new FormData();

      const value = newEditor.value;
      const caretPos = newEditor.selectionStart || 0;
      const marker = "\n\n<div id=\"__cursor_marker__\"></div>\n\n";
      const withMarker = value.slice(0, caretPos) + marker + value.slice(caretPos);

      formData.append('content', withMarker);

      const prevScrollTop = newPreview.scrollTop;
      const prevMax = Math.max(1, newPreview.scrollHeight - newPreview.clientHeight);
      const prevRatio = prevScrollTop / prevMax;

      fetch(previewUrlNew, { method: 'POST', body: formData })
      .then(res => res.text())
      .then(html => {
        newPreview.innerHTML = html;

        // âœ… MathJax ì¬ë Œë”
        if (window.MathJax && MathJax.typesetPromise) {
          MathJax.typesetPromise([newPreview]).catch(err => console.error('MathJax typeset error', err));
        }

        const markerEl = newPreview.querySelector('#__cursor_marker__');
        if (markerEl) {
          markerEl.scrollIntoView({ block: 'center' });
        } else {
          const max = Math.max(1, newPreview.scrollHeight - newPreview.clientHeight);
          newPreview.scrollTop = max * prevRatio;
        }
      })
      .catch(err => console.error('preview error', err));
    }, 200);
  }
  newEditor.addEventListener('input', schedulePreviewUpdateNew);
  newEditor.addEventListener('click', schedulePreviewUpdateNew);
  newEditor.addEventListener('keyup', schedulePreviewUpdateNew);
  window.addEventListener('load', schedulePreviewUpdateNew);

  // ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°
  newEditor.addEventListener('paste', function (e) {
    const items = (e.clipboardData || e.originalEvent?.clipboardData)?.items;
    if (!items) return;

    for (const item of items) {
      if (item.type && item.type.indexOf('image') !== -1) {
        e.preventDefault();
        const file = item.getAsFile();
        if (!file) return;

        const formData = new FormData();
        formData.append('base_rel_dir', imageBaseDirNew);
        formData.append('image', file);

        fetch(uploadUrlNew, {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok && data.md_path) {
            const md = `![pasted image](${data.md_path})\n`;
            insertAtCursorNew(newEditor, md);
            schedulePreviewUpdateNew();
          } else {
            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(err => {
          console.error(err);
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });

        break;
      }
    }
  });
</script>

{% endblock %}
{% extends "base.html" %}
{% block content %}

<div class="project-header"
     style="--accent-color: {{ theme.accent }}; flex-wrap: wrap; gap: 8px;">
  <div>
    <h2>í”„ë¡œì íŠ¸: {{ project_name }}</h2>
    <p class="meta">ê²½ë¡œ: {{ project_rel_path }}</p>
  </div>
  <div class="project-header-actions"
       style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end;">
    <a class="btn-secondary" href="{{ url_for('index') }}">
      â† í”„ë¡œì íŠ¸ ëª©ë¡ìœ¼ë¡œ
    </a>
    <a class="btn" href="{{ url_for('new_file') }}?rel_path={{ project_rel_path }}">
      ï¼‹ ìƒˆ ë¬¸ì„œ
    </a>
    <a class="btn-secondary" href="{{ url_for('settings_view') }}?rel_path={{ project_rel_path }}">
      âš™ ì„¤ì •
    </a>
  </div>
</div>

<form method="get"
      action="{{ url_for('project_view') }}"
      class="note-filter-form">
  <input type="hidden" name="rel_path" value="{{ project_rel_path }}">

  <label>
    ì •ë ¬:
    <select name="sort">
      <option value="modified" {{ 'selected' if sort == 'modified' else '' }}>ìˆ˜ì •ì¼</option>
      <option value="created" {{ 'selected' if sort == 'created' else '' }}>ìƒì„±ì¼</option>
      <option value="name"     {{ 'selected' if sort == 'name'     else '' }}>íŒŒì¼ëª…</option>
    </select>
  </label>

  <label>
    ë°©í–¥:
    <select name="order">
      <option value="desc" {{ 'selected' if order == 'desc' else '' }}>ë‚´ë¦¼ì°¨ìˆœ</option>
      <option value="asc"  {{ 'selected' if order == 'asc'  else '' }}>ì˜¤ë¦„ì°¨ìˆœ</option>
    </select>
  </label>

  <label>
    í˜ì´ì§€ë‹¹:
    <select name="page_size">
      <option value="10"  {{ 'selected' if page_size == 10  else '' }}>10</option>
      <option value="20"  {{ 'selected' if page_size == 20  else '' }}>20</option>
      <option value="50"  {{ 'selected' if page_size == 50  else '' }}>50</option>
      <option value="100" {{ 'selected' if page_size == 100 else '' }}>100</option>
    </select>
  </label>

  <label class="note-filter-search" style="flex: 1 1 200px;">
    ê²€ìƒ‰:
    <input type="text"
           name="q"
           value="{{ q }}"
           placeholder="íŒŒì¼ëª… / ê²½ë¡œ / íƒœê·¸ / ìƒíƒœ ê²€ìƒ‰">
  </label>

  <button type="submit" class="btn-secondary">ì ìš©</button>
</form>
{% if notes %}
  <div class="note-table-wrapper">
    <table class="note-table">
      <thead>
        <tr>
          <th>ì œëª©</th>
          <th>ìˆ˜ì •ì¼ì‹œ</th>
          <th style="width: 160px;">ì•¡ì…˜</th>
        </tr>
      </thead>
      <tbody>
        {% for note in notes %}
          {# ë©”ì¸ í–‰: ì œëª© + ìˆ˜ì •ì¼ + ì•¡ì…˜ #}
          <tr class="note-row">
            <td class="note-title-cell">
              <a href="{{ url_for('view_file') }}?rel_path={{ note.rel_path }}">
                {{ note.name }}
              </a>
            </td>
            <td class="note-date-cell">
              {{ note.modified }}
            </td>
            <td class="note-action-cell">
              <a class="btn-secondary"
                 href="{{ url_for('edit_file') }}?rel_path={{ note.rel_path }}">
                í¸ì§‘
              </a>
              <form method="post"
                    action="{{ url_for('toggle_favorite') }}"
                    style="display:inline;">
                <input type="hidden" name="rel_path" value="{{ note.rel_path }}">
                <button type="submit"
                        class="btn-secondary"
                        style="margin-left: 4px;">
                  {% if note.is_favorite %}â˜…{% else %}â˜†{% endif %}
                </button>
              </form>
              <button type="button"
                      class="btn-secondary btn-xs note-details-toggle"
                      data-target="note-details-{{ loop.index }}">
                ìƒì„¸ â–¼
              </button>
            </td>
          </tr>

          {# ìƒì„¸ ì •ë³´ í† ê¸€ í–‰: ê²½ë¡œ/íƒœê·¸/ìƒíƒœ/TODO/ìƒì„±ì¼ì‹œ #}
          <tr id="note-details-{{ loop.index }}" class="note-details-row">
            <td colspan="3">
              <div class="note-details">
                <div class="note-details-item">
                  <span class="note-details-label">ê²½ë¡œ</span>
                  <span class="note-details-value path">{{ note.rel_path }}</span>
                </div>
                {% if note.tags %}
                  <div class="note-details-item">
                    <span class="note-details-label">íƒœê·¸</span>
                    <span class="note-details-value">
                      {% for tag in note.tags %}
                        <span class="tag">#{{ tag }}</span>
                      {% endfor %}
                    </span>
                  </div>
                {% endif %}
                {% if note.status %}
                  <div class="note-details-item">
                    <span class="note-details-label">ìƒíƒœ</span>
                    <span class="note-details-value">{{ note.status }}</span>
                  </div>
                {% endif %}
                <div class="note-details-item">
                  <span class="note-details-label">TODO</span>
                  <span class="note-details-value">
                    {% if note.todo_open > 0 %}
                      {{ note.todo_open }}ê°œ ì—´ë¦¼
                    {% else %}
                      ì—†ìŒ
                    {% endif %}
                  </span>
                </div>
                <div class="note-details-item">
                  <span class="note-details-label">ìƒì„±ì¼ì‹œ</span>
                  <span class="note-details-value">{{ note.created }}</span>
                </div>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if total_pages > 1 %}
    <div class="pagination">
      {% if page > 1 %}
        <a class="page-link"
           href="{{ url_for('project_view',
                            rel_path=project_rel_path,
                            sort=sort,
                            order=order,
                            page=page-1,
                            page_size=page_size,
                            q=q) }}">
          â€¹ ì´ì „
        </a>
      {% endif %}

      {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
          <span class="page-link current">{{ p }}</span>
        {% else %}
          <a class="page-link"
             href="{{ url_for('project_view',
                              rel_path=project_rel_path,
                              sort=sort,
                              order=order,
                              page=p,
                              page_size=page_size,
                              q=q) }}">
            {{ p }}
          </a>
        {% endif %}
      {% endfor %}

      {% if page < total_pages %}
        <a class="page-link"
           href="{{ url_for('project_view',
                            rel_path=project_rel_path,
                            sort=sort,
                            order=order,
                            page=page+1,
                            page_size=page_size,
                            q=q) }}">
          ë‹¤ìŒ â€º
        </a>
      {% endif %}
    </div>
  {% endif %}
{% else %}
  <p>ì´ í”„ë¡œì íŠ¸ì—ëŠ” .md íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const toggles = document.querySelectorAll('.note-details-toggle');

    toggles.forEach(function (btn) {
      btn.addEventListener('click', function () {
        const targetId = btn.getAttribute('data-target');
        const row = document.getElementById(targetId);
        if (!row) return;

        const isHidden = row.style.display === '' || row.style.display === 'none';
        row.style.display = isHidden ? 'table-row' : 'none';
        btn.textContent = isHidden ? 'ìƒì„¸ â–²' : 'ìƒì„¸ â–¼';
      });
    });
  });
</script>

{% endblock %}
{% extends "base.html" %}
{% block content %}

<h2>ì „ì—­ ê²€ìƒ‰</h2>

<form method="get"
      action="{{ url_for('global_search') }}"
      class="note-filter-form">
  <label>
    ê²€ìƒ‰ì–´
    <input type="text"
           name="q"
           value="{{ q }}"
           placeholder="ì˜ˆ: DFT tag:MOF status:in-progress">
  </label>
  <button type="submit" class="btn">ê²€ìƒ‰</button>
  <p class="meta" style="flex-basis: 100%; margin-top: 4px;">
    DSL ì˜ˆì‹œ:
    <code>tag:DFT</code>,
    <code>status:done</code>,
    <code>DFT IL tag:MD</code> (ë„ì–´ì“°ê¸°ë¡œ AND)
  </p>
</form>

{% if q %}
  <p class="meta" style="margin-top: 4px;">
    "{{ q }}" ê²€ìƒ‰ ê²°ê³¼: {{ total }}ê°œ
  </p>
{% endif %}

{% if results %}
  <ul class="search-results">
    {% for r in results %}
      <li class="search-result-item">
        <div class="search-result-title">
          <a href="{{ url_for('view_file') }}?rel_path={{ r.rel_path }}">
            {{ r.name }}
          </a>
        </div>
        <div class="search-result-path meta">
          {{ r.rel_path }} Â· {{ r.modified }}
        </div>

        {% if r.tags or r.status %}
          <div class="search-result-meta meta" style="margin-top: 2px;">
            {% if r.tags %}
              íƒœê·¸:
              {% for t in r.tags %}
                <span class="tag">#{{ t }}</span>
              {% endfor %}
            {% endif %}
            {% if r.status %}
              Â· ìƒíƒœ: {{ r.status }}
            {% endif %}
          </div>
        {% endif %}

        {% if r.snippet_html %}
          <div class="search-result-snippet">
            {{ r.snippet_html | safe }} â€¦
          </div>
        {% endif %}
      </li>
    {% endfor %}
  </ul>

  {% if total_pages > 1 %}
    <div class="pagination">
      {% if page > 1 %}
        <a class="page-link"
           href="{{ url_for('global_search',
                            q=q,
                            page=page-1,
                            page_size=page_size) }}">
          â€¹ ì´ì „
        </a>
      {% endif %}

      {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
          <span class="page-link current">{{ p }}</span>
        {% else %}
          <a class="page-link"
             href="{{ url_for('global_search',
                              q=q,
                              page=p,
                              page_size=page_size) }}">
            {{ p }}
          </a>
        {% endif %}
      {% endfor %}

      {% if page < total_pages %}
        <a class="page-link"
           href="{{ url_for('global_search',
                            q=q,
                            page=page+1,
                            page_size=page_size) }}">
          ë‹¤ìŒ â€º
        </a>
      {% endif %}
    </div>
  {% endif %}
{% elif q %}
  <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

{% endblock %}
{% extends "base.html" %}
{% block content %}

<h2>í”„ë¡œì íŠ¸ í…Œë§ˆ ì„¤ì •</h2>
<p class="meta">
  í”„ë¡œì íŠ¸: {{ project_name }}<br>
  ê²½ë¡œ: {{ project_rel_path }}
</p>

<form method="post"
      action="{{ url_for('settings_save') }}"
      class="settings-form"
      style="max-width: 480px; margin-top: 12px;">
  <input type="hidden" name="rel_path" value="{{ project_rel_path }}">

  <div class="settings-row"
       style="display: flex; flex-wrap: wrap;
              gap: 8px; align-items: center; margin-bottom: 8px;">
    <label for="card_bg" style="min-width: 130px;">
      ì¹´ë“œ ë°°ê²½ìƒ‰
    </label>
    <input type="color"
           id="card_bg"
           name="card_bg"
           value="{{ theme.card_bg }}">
  </div>

  <div class="settings-row"
       style="display: flex; flex-wrap: wrap;
              gap: 8px; align-items: center; margin-bottom: 8px;">
    <label for="card_border" style="min-width: 130px;">
      ì¹´ë“œ í…Œë‘ë¦¬ìƒ‰
    </label>
    <input type="color"
           id="card_border"
           name="card_border"
           value="{{ theme.card_border }}">
  </div>

  <div class="settings-row"
       style="display: flex; flex-wrap: wrap;
              gap: 8px; align-items: center; margin-bottom: 8px;">
    <label for="accent" style="min-width: 130px;">
      í¬ì»¤ìŠ¤ / ë²„íŠ¼ ìƒ‰ (accent)
    </label>
    <input type="color"
           id="accent"
           name="accent"
           value="{{ theme.accent }}">
  </div>

  <div class="settings-row"
       style="display: flex; flex-wrap: wrap;
              gap: 8px; align-items: center; margin-bottom: 8px;">
    <label for="header_bg" style="min-width: 130px;">
      í—¤ë” ë°°ê²½ìƒ‰
    </label>
    <input type="color"
           id="header_bg"
           name="header_bg"
           value="{{ theme.header_bg }}">
  </div>

  <div class="settings-actions" style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
    <button type="submit" class="btn">ì €ì¥</button>
    <a href="{{ url_for('project_view') }}?rel_path={{ project_rel_path }}"
       class="btn-secondary">
      ì·¨ì†Œ
    </a>
  </div>
</form>

{% endblock %}
{% extends "base.html" %}
{% block content %}

<h2>TODO / Task ëª¨ì•„ë³´ê¸°</h2>

<form method="get"
      action="{{ url_for('tasks_view') }}"
      class="note-filter-form">
  <label style="display: inline-flex; align-items: center; gap: 4px;">
    ì™„ë£Œëœ ì‘ì—…ë„ í¬í•¨
    <input type="checkbox"
           name="include_done"
           value="true"
           {% if include_done %}checked{% endif %}
           onchange="this.form.submit()">
  </label>
</form>

{% if files %}
  {% for f in files %}
    <section class="task-file"
             style="margin-top: 12px; margin-bottom: 12px;
                    padding: 10px 12px;
                    border-radius: 8px;
                    border: 1px solid var(--card-border);
                    background-color: var(--card-bg);">
      <h3 style="margin: 0 0 4px 0;">
        <a href="{{ url_for('view_file') }}?rel_path={{ f.rel_path }}">
          {{ f.name }}
        </a>
      </h3>
      <p class="meta" style="margin: 0 0 6px 0;">{{ f.rel_path }}</p>

      <ul class="task-list">
        {% for t in f.tasks %}
          <li class="task-item">
            {% if t.done %}[x]{% else %}[ ]{% endif %}
            (L{{ t.line_no }}) {{ t.text }}
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endfor %}
{% else %}
  <p>í˜„ì¬ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” TODO í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

{% endblock %}
{% extends "base.html" %}

{% block extra_head %}
  {% if media_base_url %}
    <base href="{{ media_base_url }}/">
  {% endif %}

  <style>
    .hl-toolbar{
      position: fixed; z-index: 9999;
      background: #fff; border: 1px solid #ddd; border-radius: 10px;
      padding: 10px; box-shadow: 0 6px 24px rgba(0,0,0,.12);
      max-width: 360px; width: 320px;
    }
    @media (max-width: 480px){
      .hl-toolbar{ width: min(92vw, 360px); max-width: 92vw; }
    }

    .hl-colors{ display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .hl-color{
      width: 22px; height: 22px; border-radius: 6px;
      border: 1px solid #ccc; cursor: pointer;
    }
    .hl-color[data-color="#fff59d"]{ background:#fff59d; }
    .hl-color[data-color="#c8e6c9"]{ background:#c8e6c9; }
    .hl-color[data-color="#bbdefb"]{ background:#bbdefb; }
    .hl-color[data-color="#ffcdd2"]{ background:#ffcdd2; }
    #hl-custom{ width: 40px; height: 24px; padding:0; border:none; background:transparent; cursor:pointer; }
    .hl-note{ width:100%; box-sizing:border-box; padding:8px; border:1px solid #ddd; border-radius:8px; margin-bottom:8px; }
    .hl-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    /* í•˜ì´ë¼ì´íŠ¸ ê¸°ë³¸ */
    .hl-span{ border-radius: 4px; padding: 0 2px; cursor: pointer; }

    /* ë©”ëª¨ê°€ ìˆìœ¼ë©´ ë§ˆì§€ë§‰ spanì—ë§Œ ğŸ’¬ í‘œì‹œ */
    .hl-span[data-hl-end="1"][data-hl-note]:not([data-hl-note=""])::after{
      content: "ğŸ’¬";
      font-size: 1.0em;
      margin-left: 3px;
      opacity: 0.9;
      vertical-align: middle;
      color: #111;
    }

    /* âœ… ìš°ì¸¡í•˜ë‹¨ sticky í† ê¸€(FAB) */
    .hl-fab{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 10001;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: 0 10px 28px rgba(0,0,0,.18);
      background: #fff;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
    }
    .hl-fab .dot{
      width: 10px; height: 10px; border-radius: 50%;
      background: #2e7d32; /* ON */
    }
    .hl-fab[data-on="0"] .dot{ background: #9e9e9e; } /* OFF */
    .hl-fab .label{ font-size: 13px; }
    @media (max-width: 480px){
      .hl-fab{ right: 12px; bottom: 12px; padding: 10px 12px; }
      .hl-fab .label{ font-size: 12px; }
    }

    /* í°ì—ì„œ í„°ì¹˜ ìŠ¤í¬ë¡¤ ì•ˆì • */
    #md-container{ -webkit-overflow-scrolling: touch; }
  </style>
{% endblock %}

{% block content %}

<div class="detail-header"
     style="--accent-color: {{ theme.accent if theme else '#1f7aec' }};">
  <div class="detail-nav-left">
    {% if project_rel_path %}
      <a class="btn-secondary"
         href="{{ url_for('project_view') }}?rel_path={{ project_rel_path }}">
        â† {{ project_name or 'í”„ë¡œì íŠ¸' }} ëª©ë¡ìœ¼ë¡œ
      </a>
    {% else %}
      <button type="button"
              class="btn-secondary"
              onclick="window.history.back()">
        â† ë’¤ë¡œê°€ê¸°
      </button>
    {% endif %}
  </div>
  <div class="detail-nav-right" style="display: flex; gap: 8px; flex-wrap: wrap;">
    {% if is_markdown %}
      <a class="btn-secondary"
         href="{{ url_for('edit_file') }}?rel_path={{ rel_path }}">
        âœï¸ í¸ì§‘
      </a>
    {% endif %}
    <form method="post"
          action="{{ url_for('toggle_favorite') }}"
          style="display:inline;">
      <input type="hidden" name="rel_path" value="{{ rel_path }}">
      <button type="submit" class="btn-secondary">
        {% if is_favorite %}â˜… ì¦ê²¨ì°¾ê¸° í•´ì œ{% else %}â˜† ì¦ê²¨ì°¾ê¸°{% endif %}
      </button>
    </form>
  </div>
</div>

<div class="viewer-layout">
  <section class="viewer-main">
    <h2>{{ file_name }}</h2>
    <p class="meta">
      ê²½ë¡œ: {{ rel_path }}<br>
      íƒ€ì…: {{ file_type }}
    </p>

    <p style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
      <a class="btn" href="{{ download_file_url }}">â¬‡ï¸ ì›ë³¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a>

      {% if is_markdown %}
        <a class="btn-secondary" href="{{ url_for('download_pdf', rel_path=rel_path) }}">ğŸ“„ PDFë¡œ ë‹¤ìš´ë¡œë“œ</a>
      {% endif %}

      {% if is_markdown and download_bundle_url %}
        <a class="btn-secondary" href="{{ download_bundle_url }}">â¬‡ï¸ MD + ì´ë¯¸ì§€ ë²ˆë“¤(.zip)</a>
      {% endif %}
    </p>

    {% if is_markdown and meta %}
      <details class="meta-details" id="frontmatter-details" open>
        <summary>ë©”íƒ€ë°ì´í„° (frontmatter)</summary>

        <table class="meta-table">
          <tbody>
          {% for k, v in meta.items() %}
            <tr>
              <th>{{ k }}</th>
              <td>
                {% if v is sequence and v is not string %}
                  <ul class="meta-list">
                    {% for item in v %}
                      <li>{{ item }}</li>
                    {% endfor %}
                  </ul>
                {% elif v is mapping %}
                  <pre class="meta-json">{{ v | tojson(indent=2) }}</pre>
                {% else %}
                  {{ v }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </details>
    {% endif %}

    {% if tags %}
      <p class="meta">
        íƒœê·¸:
        {% for t in tags %}
          <span class="tag">#{{ t }}</span>
        {% endfor %}
      </p>
    {% endif %}

    {% if status %}
      <p class="meta">
        ìƒíƒœ: <strong>{{ status }}</strong>
        {% if todo_open_count %}
          (ì—´ë¦° TODO: {{ todo_open_count }}ê°œ)
        {% endif %}
      </p>
    {% endif %}

    {% if is_pdf %}
      <h3>PDF ë¯¸ë¦¬ë³´ê¸°</h3>
      <embed src="{{ download_file_url }}"
             type="application/pdf"
             width="100%"
             height="800px" />

    {% elif html_content %}
      <div class="markdown-body" id="md-container">
        {{ html_content | safe }}
      </div>

      <!-- âœ… ìš°ì¸¡í•˜ë‹¨ í˜•ê´‘íœ ON/OFF í† ê¸€ -->
      <button id="hl-fab" class="hl-fab" type="button" aria-pressed="true" data-on="1" title="í˜•ê´‘íœ ëª¨ë“œ ON/OFF">
        <span class="dot" aria-hidden="true"></span>
        <span class="label">í˜•ê´‘íœ</span>
      </button>

      <!-- âœ… í•˜ì´ë¼ì´íŠ¸ íˆ´ë°” -->
      <div id="hl-toolbar" class="hl-toolbar" style="display:none;">
        <div class="hl-colors">
          <button type="button" class="hl-color" data-color="#fff59d" title="Yellow"></button>
          <button type="button" class="hl-color" data-color="#c8e6c9" title="Green"></button>
          <button type="button" class="hl-color" data-color="#bbdefb" title="Blue"></button>
          <button type="button" class="hl-color" data-color="#ffcdd2" title="Red"></button>
          <input type="color" id="hl-custom" title="Custom color" />
        </div>

        <input id="hl-note" class="hl-note" placeholder="ë©”ëª¨(ì˜µì…˜)" />

        <div class="hl-actions">
          <button type="button" id="hl-edit" class="btn-secondary">ì—¬ê¸°ë¶€í„° ìˆ˜ì •</button>

          <button type="button" id="hl-save" class="btn">ì €ì¥</button>
          <button type="button" id="hl-update" class="btn-secondary" style="display:none;">ìƒ‰/ë©”ëª¨ ìˆ˜ì •</button>
          <button type="button" id="hl-delete" class="btn-secondary" style="display:none;">ì‚­ì œ</button>
          <button type="button" id="hl-cancel" class="btn-secondary">ë‹«ê¸°</button>
        </div>
      </div>

      <script>
        (function(){
          const REL_PATH = {{ rel_path|tojson }};
          const NOTE_HASH = {{ content_hash|tojson }};
          const EDIT_URL = {{ (url_for('edit_file') ~ '') | tojson }};

          const container = document.getElementById("md-container");
          if (!container) return;

          const fab = document.getElementById("hl-fab");
          const toolbar = document.getElementById("hl-toolbar");
          const noteInput = document.getElementById("hl-note");
          const editBtn = document.getElementById("hl-edit");
          const saveBtn = document.getElementById("hl-save");
          const updateBtn = document.getElementById("hl-update");
          const deleteBtn = document.getElementById("hl-delete");
          const cancelBtn = document.getElementById("hl-cancel");
          const customColor = document.getElementById("hl-custom");

          const log = (...args) => console.log("[HL]", ...args);

          // âœ… Undo ìŠ¤íƒ + í˜„ì¬ í•˜ì´ë¼ì´íŠ¸ ìƒíƒœ
          const undoStack = [];
          const hlMap = new Map(); // id -> {id,start,end,color,note,text,content_hash}

          function isTypingTarget(el){
            return el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA" || el.isContentEditable);
          }

          function unwrapHighlight(id){
            document.querySelectorAll(`[data-hl-id="${id}"]`).forEach(span => {
              span.replaceWith(document.createTextNode(span.textContent || ""));
            });
          }

          // =========================
          // âœ… í˜•ê´‘íœ ëª¨ë“œ í† ê¸€ (localStorage)
          // =========================
          const LS_KEY = "highlight_enabled_v1";
          let highlightEnabled = true;

          function setMode(on){
            highlightEnabled = !!on;
            fab.dataset.on = highlightEnabled ? "1" : "0";
            fab.setAttribute("aria-pressed", highlightEnabled ? "true" : "false");
            if (!highlightEnabled) {
              hideToolbar();
              const sel = window.getSelection();
              if (sel) sel.removeAllRanges();
            }
            try { localStorage.setItem(LS_KEY, highlightEnabled ? "1" : "0"); } catch(e){}
            log("mode:", highlightEnabled ? "ON" : "OFF");
          }

          (function initMode(){
            try{
              const v = localStorage.getItem(LS_KEY);
              if (v === "0") setMode(false);
              else setMode(true);
            }catch(e){
              setMode(true);
            }
          })();

          fab.addEventListener("click", () => setMode(!highlightEnabled));

          // =========================
          // UI helpers
          // =========================
          let currentColor = "#fff59d";
          let pendingRange = null;   // selection ê¸°ë°˜
          let editingId = null;      // ê¸°ì¡´ highlight í´ë¦­ ê¸°ë°˜

          let lastPoint = { x: Math.round(window.innerWidth/2), y: Math.round(window.innerHeight/2) };

          // âœ… í•µì‹¬: ë“œë˜ê·¸(ë²„íŠ¼ ëˆ„ë¥¸ ìƒíƒœ)ì—ì„œëŠ” ì ˆëŒ€ íˆ´ë°” ì˜¤í”ˆ ê¸ˆì§€
          let isPointerDown = false;

          container.addEventListener("pointerdown", (e) => {
            isPointerDown = true;
            lastPoint = { x: e.clientX || lastPoint.x, y: e.clientY || lastPoint.y };
          }, { passive: true });

          // pointerê°€ ì»¨í…Œì´ë„ˆ ë°–ì—ì„œ ì˜¬ë¼ê°€ë„ ìƒíƒœ ë³µêµ¬
          document.addEventListener("pointerup", () => {
            isPointerDown = false;
          }, { passive: true });

          function showToolbar(x, y){
            const w = Math.min(340, Math.max(260, window.innerWidth * 0.92));
            const left = Math.max(12, Math.min(x, window.innerWidth - (w + 12)));
            const top  = Math.max(12, Math.min(y, window.innerHeight - 220));
            toolbar.style.left = left + "px";
            toolbar.style.top  = top + "px";
            toolbar.style.display = "block";
          }

          function focusNoteNow(){
            // âœ… íˆ´ë°” ëœ¨ìë§ˆì input focus
            try { noteInput.focus({ preventScroll: true }); }
            catch(e){ try { noteInput.focus(); } catch(_e){} }
          }

          function hideToolbar(){
            toolbar.style.display = "none";
            pendingRange = null;
            editingId = null;
            noteInput.value = "";
            saveBtn.style.display = "inline-block";
            updateBtn.style.display = "none";
            deleteBtn.style.display = "none";
          }

          function primaryAction(){
            const saving = saveBtn && saveBtn.style.display !== "none";
            if (saving) saveBtn.click();
            else updateBtn.click();
          }

          noteInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              primaryAction();
            } else if (e.key === "Escape") {
              e.preventDefault();
              hideToolbar();
            }
          });

          function getOffsetsFromRange(range){
            const pre1 = document.createRange();
            pre1.selectNodeContents(container);
            pre1.setEnd(range.startContainer, range.startOffset);
            const start = pre1.toString().length;

            const pre2 = document.createRange();
            pre2.selectNodeContents(container);
            pre2.setEnd(range.endContainer, range.endOffset);
            const end = pre2.toString().length;

            return { start, end, text: range.toString() };
          }

          function applyHighlightByOffsets(start, end, id, color, note){
            if (end <= start) return;

            const nodes = [];
            let pos = 0;
            const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null);
            let n;
            while(n = walker.nextNode()){
              const len = (n.nodeValue || "").length;
              nodes.push({ node: n, start: pos, end: pos + len });
              pos += len;
            }

            let endMarked = false;
            const memo = (note || "").trim();

            for (let i = nodes.length - 1; i >= 0; i--){
              const info = nodes[i];
              if (info.end <= start) break;
              if (info.start >= end) continue;

              const a = Math.max(start, info.start) - info.start;
              const b = Math.min(end, info.end) - info.start;
              if (b <= a) continue;

              const full = info.node.nodeValue || "";
              const before = full.slice(0, a);
              const mid = full.slice(a, b);
              const after = full.slice(b);

              const frag = document.createDocumentFragment();
              if (before) frag.appendChild(document.createTextNode(before));

              const span = document.createElement("span");
              span.className = "hl-span";
              span.dataset.hlId = id;
              span.dataset.hlColor = color || "";
              span.dataset.hlNote = memo;
              span.style.backgroundColor = color;

              if (memo) span.title = memo;
              else span.removeAttribute("title");

              if (!endMarked){
                span.dataset.hlEnd = "1";
                endMarked = true;
              }

              span.textContent = mid;
              frag.appendChild(span);

              if (after) frag.appendChild(document.createTextNode(after));

              info.node.parentNode.replaceChild(frag, info.node);
            }
          }

          function setAllSpansColor(id, color){
            document.querySelectorAll(`[data-hl-id="${id}"]`).forEach(el => {
              el.style.backgroundColor = color;
              el.dataset.hlColor = color || "";
            });
          }

          function setAllSpansNote(id, note){
            const n = (note || "").trim();
            document.querySelectorAll(`[data-hl-id="${id}"]`).forEach(el => {
              el.dataset.hlNote = n;
              if (n) el.title = n;
              else el.removeAttribute("title");
            });
          }

          function getHighlightTextById(id){
            const st = hlMap.get(id);
            if (st && st.text) return (st.text || "").trim();

            const spans = Array.from(document.querySelectorAll(`[data-hl-id="${id}"]`));
            const s = spans.map(x => x.textContent || "").join("");
            return (s || "").trim();
          }

          // =========================
          // âœ… ì—¬ê¸°ë¶€í„° ìˆ˜ì • (í¸ì§‘ ì´ë™)
          // =========================
          function gotoEdit(snippet, startHint){
            const s = (snippet || "").trim().slice(0, 500);
            const start = Number.isFinite(startHint) ? Math.max(0, Math.floor(startHint)) : 0;

            const url =
              `${EDIT_URL}?rel_path=${encodeURIComponent(REL_PATH)}`
              + `&focus=1`
              + `&start=${encodeURIComponent(String(start))}`
              + `&snippet=${encodeURIComponent(s)}`;

            log("gotoEdit:", { start, snippet: s });
            window.location.href = url;
          }

          editBtn.addEventListener("click", () => {
            try{
              if (!highlightEnabled) return;

              if (editingId){
                const snippet = getHighlightTextById(editingId);
                const st = hlMap.get(editingId);
                const startHint = st ? st.start : 0;
                gotoEdit(snippet, startHint);
                return;
              }

              if (pendingRange){
                const { start, text } = getOffsetsFromRange(pendingRange);
                gotoEdit(text || "", start);
                return;
              }

              gotoEdit("", 0);
            }catch(e){
              alert("í¸ì§‘ ì´ë™ ì‹¤íŒ¨: " + (e && e.message ? e.message : e));
            }
          });

          // =========================
          // API
          // =========================
          async function apiGetHighlights(){
            const url = `/research/highlights?rel_path=${encodeURIComponent(REL_PATH)}`;
            const res = await fetch(url);
            return await res.json();
          }

          async function apiAddHighlight(payload){
            const res = await fetch("/research/highlights/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json().catch(()=>({}));
            if (!res.ok) throw new Error(data.detail || "add failed");
            return data;
          }

          async function apiUpdateHighlight(payload){
            const res = await fetch("/research/highlights/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json().catch(()=>({}));
            if (!res.ok) throw new Error(data.detail || "update failed");
            return data;
          }

          async function apiDeleteHighlight(payload){
            const res = await fetch("/research/highlights/delete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json().catch(()=>({}));
            if (!res.ok) throw new Error(data.detail || "delete failed");
            return data;
          }

          // ìƒ‰ìƒ ì„ íƒ
          toolbar.querySelectorAll(".hl-color").forEach(btn => {
            btn.addEventListener("click", () => {
              currentColor = btn.dataset.color;
              customColor.value = currentColor;
            });
          });
          customColor.addEventListener("input", () => {
            currentColor = customColor.value;
          });
          customColor.value = currentColor;

          // =========================
          // âœ… ì„ íƒ ê°ì§€: "pointerup" ì—ì„œë§Œ íˆ´ë°” ì˜¤í”ˆ
          // - selectionchangeì—ì„œëŠ” ì ˆëŒ€ ì˜¤í”ˆí•˜ì§€ ì•ŠìŒ
          // =========================
          function tryOpenToolbarFromSelection(){
            if (!highlightEnabled) return;
            if (isTypingTarget(document.activeElement)) return;

            // âœ… ë“œë˜ê·¸ ì¤‘(ë²„íŠ¼ ëˆ„ë¥¸ ìƒíƒœ)ì—ëŠ” ì ˆëŒ€ ì—´ì§€ ì•ŠìŒ
            if (isPointerDown) return;

            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) return;

            const range = sel.getRangeAt(0);
            if (range.collapsed) return;
            if (!container.contains(range.commonAncestorContainer)) return;

            pendingRange = range.cloneRange();
            editingId = null;

            saveBtn.style.display = "inline-block";
            updateBtn.style.display = "none";
            deleteBtn.style.display = "none";
            noteInput.value = "";

            let rect = range.getBoundingClientRect();
            if (!rect || (rect.width === 0 && rect.height === 0)) {
              showToolbar(lastPoint.x, lastPoint.y - 10);
            } else {
              showToolbar(rect.left + rect.width/2, rect.top - 10);
            }

            // âœ… íˆ´ë°” ëœ¨ìë§ˆì focus
            setTimeout(focusNoteNow, 0);
          }

          // âœ… (2) pointerup ë•Œë§Œ ì˜¤í”ˆ
          // - setTimeoutìœ¼ë¡œ selection í™•ì •ëœ ë’¤ ì‹¤í–‰
          container.addEventListener("pointerup", () => {
            setTimeout(tryOpenToolbarFromSelection, 0);
          }, { passive: true });

          // âœ… (1) selectionchangeëŠ” "ì ˆëŒ€ ì˜¤í”ˆ" ê¸ˆì§€: ì™„ì „ ë¬´ì‹œ(í˜¹ì€ ë¡œê¹…ë§Œ)
          // document.addEventListener("selectionchange", () => {});

          // ê¸°ì¡´ í•˜ì´ë¼ì´íŠ¸ í´ë¦­ â†’ í¸ì§‘ ëª¨ë“œ
          container.addEventListener("click", (e) => {
            const el = e.target.closest(".hl-span");
            if (!el) return;

            if (!highlightEnabled) return;

            editingId = el.dataset.hlId || null;
            pendingRange = null;

            const storedNote = el.dataset.hlNote || "";
            const storedColor = el.dataset.hlColor || currentColor;
            noteInput.value = storedNote;
            currentColor = storedColor;
            customColor.value = currentColor;

            saveBtn.style.display = "none";
            updateBtn.style.display = "inline-block";
            deleteBtn.style.display = "inline-block";

            showToolbar(e.clientX || lastPoint.x, e.clientY || lastPoint.y);

            // âœ… íˆ´ë°” ëœ¨ìë§ˆì focus
            setTimeout(focusNoteNow, 0);
          });

          // ì €ì¥
          saveBtn.addEventListener("click", async () => {
            try{
              if (!highlightEnabled) return;
              if (!pendingRange) return;

              const {start, end, text} = getOffsetsFromRange(pendingRange);
              const memo = (noteInput.value || "").trim();

              const payload = {
                rel_path: REL_PATH,
                start, end,
                color: currentColor,
                text: (text || "").trim(),
                content_hash: NOTE_HASH,
                note: memo
              };

              const res = await apiAddHighlight(payload);
              const hid = res.id;

              applyHighlightByOffsets(start, end, hid, currentColor, memo);

              hlMap.set(hid, { id: hid, start, end, color: currentColor, note: memo, text: payload.text, content_hash: NOTE_HASH });
              undoStack.push({ op: "add", id: hid });

              const sel = window.getSelection();
              if (sel) sel.removeAllRanges();
              hideToolbar();
            }catch(err){
              alert("í•˜ì´ë¼ì´íŠ¸ ì €ì¥ ì‹¤íŒ¨: " + (err.message || err));
            }
          });

          // ìˆ˜ì •
          updateBtn.addEventListener("click", async () => {
            try{
              if (!highlightEnabled) return;
              if (!editingId) return;

              const memo = (noteInput.value || "").trim();
              const prev = hlMap.get(editingId) || {};

              await apiUpdateHighlight({
                rel_path: REL_PATH,
                id: editingId,
                color: currentColor,
                note: memo
              });

              setAllSpansColor(editingId, currentColor);
              setAllSpansNote(editingId, memo);

              hlMap.set(editingId, { ...prev, id: editingId, color: currentColor, note: memo });
              undoStack.push({
                op: "update",
                id: editingId,
                prev: { color: prev.color, note: prev.note },
                next: { color: currentColor, note: memo }
              });

              hideToolbar();
            }catch(err){
              alert("í•˜ì´ë¼ì´íŠ¸ ìˆ˜ì • ì‹¤íŒ¨: " + (err.message || err));
            }
          });

          // ì‚­ì œ
          deleteBtn.addEventListener("click", async () => {
            try{
              if (!highlightEnabled) return;
              if (!editingId) return;

              const prev = hlMap.get(editingId);

              await apiDeleteHighlight({ rel_path: REL_PATH, id: editingId });

              unwrapHighlight(editingId);
              hlMap.delete(editingId);
              undoStack.push({ op: "delete", prev });

              hideToolbar();
            }catch(err){
              alert("í•˜ì´ë¼ì´íŠ¸ ì‚­ì œ ì‹¤íŒ¨: " + (err.message || err));
            }
          });

          cancelBtn.addEventListener("click", hideToolbar);

          // ì €ì¥ëœ í•˜ì´ë¼ì´íŠ¸ ë³µì›
          (async function init(){
            try{
              const data = await apiGetHighlights();
              const items = (data.items || []).slice();
              items.sort((a,b) => (b.start||0) - (a.start||0));

              const fullText = container.textContent || "";

              for (const it of items){
                const id = it.id;
                const color = it.color || "#fff59d";
                const memo = (it.note || "").trim();
                let s = parseInt(it.start, 10);
                let e = parseInt(it.end, 10);

                if (it.stale && it.text){
                  const needle = (it.text || "").trim();
                  if (needle){
                    const from = Math.max(0, s - 800);
                    const idx = fullText.indexOf(needle, from);
                    if (idx >= 0){
                      s = idx;
                      e = idx + needle.length;
                    } else {
                      continue;
                    }
                  }
                }

                applyHighlightByOffsets(s, e, id, color, memo);
                hlMap.set(id, { id, start: s, end: e, color, note: memo, text: it.text || "", content_hash: it.content_hash || NOTE_HASH });
              }
            }catch(err){
              console.warn("highlight init failed", err);
            }
          })();

          // ë°”ê¹¥ í´ë¦­/í„°ì¹˜ ì‹œ ë‹«ê¸°
          document.addEventListener("pointerdown", (e) => {
            if (toolbar.style.display !== "block") return;
            if (toolbar.contains(e.target)) return;
            if (e.target.closest(".hl-span")) return;
            hideToolbar();
          });

          // Ctrl+Z Undo (ì…ë ¥ì¹¸ í¬ì»¤ìŠ¤ë©´ ê¸°ë³¸ undo ìœ ì§€)
          async function undoLast(){
            if (!undoStack.length) return;
            const act = undoStack.pop();

            try{
              if (act.op === "add") {
                await apiDeleteHighlight({ rel_path: REL_PATH, id: act.id });
                unwrapHighlight(act.id);
                hlMap.delete(act.id);
                return;
              }

              if (act.op === "update") {
                const prevColor = (act.prev && act.prev.color) ? act.prev.color : "#fff59d";
                const prevNote  = (act.prev && act.prev.note)  ? act.prev.note  : "";

                await apiUpdateHighlight({
                  rel_path: REL_PATH,
                  id: act.id,
                  color: prevColor,
                  note: prevNote
                });

                setAllSpansColor(act.id, prevColor);
                setAllSpansNote(act.id, prevNote);

                const cur = hlMap.get(act.id) || {};
                hlMap.set(act.id, { ...cur, id: act.id, color: prevColor, note: prevNote });
                return;
              }

              if (act.op === "delete") {
                const prev = act.prev;
                if (!prev) return;

                const res = await apiAddHighlight({
                  rel_path: REL_PATH,
                  start: prev.start,
                  end: prev.end,
                  color: prev.color || "#fff59d",
                  text: (prev.text || "").trim(),
                  content_hash: prev.content_hash || NOTE_HASH,
                  note: (prev.note || "").trim()
                });

                const newId = res.id;
                applyHighlightByOffsets(prev.start, prev.end, newId, prev.color || "#fff59d", prev.note || "");
                hlMap.set(newId, { ...prev, id: newId });
                return;
              }
            }catch(err){
              alert("Undo ì‹¤íŒ¨: " + (err.message || err));
            }
          }

          document.addEventListener("keydown", (e) => {
            const key = (e.key || "").toLowerCase();
            const cmd = e.ctrlKey || e.metaKey;
            if (!cmd || key !== "z" || e.shiftKey) return;
            if (isTypingTarget(document.activeElement)) return;
            e.preventDefault();
            undoLast();
          });

        })();
      </script>

    {% elif text_content %}
      <pre class="code-block">{{ text_content }}</pre>
    {% else %}
      <p>{{ unsupported_reason or "ì´ íŒŒì¼ì€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." }}</p>
    {% endif %}
  </section>

  {% if attachments or other_notes or recent_notes_panel or history_versions %}
    <aside class="viewer-sidebar">
      {% if recent_notes_panel %}
        <h3>ìµœê·¼ ì—´ì–´ë³¸ ë…¸íŠ¸</h3>
        <ul class="other-notes">
          {% for n in recent_notes_panel %}
            <li>
              <a href="{{ url_for('view_file') }}?rel_path={{ n.rel_path }}">
                {{ n.name }}
              </a>
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if history_versions %}
        {% if recent_notes_panel %}<hr>{% endif %}
        <h3>ì´ì „ ìˆ˜ì • íˆìŠ¤í† ë¦¬</h3>
        <ul class="other-notes">
          {% for h in history_versions %}
            <li style="margin-bottom: 6px;">
              <div class="meta" style="margin-bottom: 2px;">
                {{ h.saved_at }}
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <a href="{{ url_for('view_file') }}?rel_path={{ h.rel_path }}">ë³´ê¸°</a>
                <a class="meta" href="{{ url_for('download_file', rel_path=h.rel_path) }}">ë‹¤ìš´ë¡œë“œ</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if attachments %}
        <h3>ì²¨ë¶€ íŒŒì¼</h3>
        <ul class="attachments-list">
          {% for att in attachments %}
            <li>
              <a href="{{ url_for('download_file', rel_path=att.rel_path) }}">
                {{ att.name }}
              </a>
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if other_notes %}
        <hr>
        <h3>ê°™ì€ í”„ë¡œì íŠ¸ì˜ ë‹¤ë¥¸ ë…¸íŠ¸</h3>
        <ul class="other-notes">
          {% for note in other_notes %}
            <li>
              <a href="{{ url_for('view_file') }}?rel_path={{ note.rel_path }}">
                {{ note.name }}
              </a>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </aside>
  {% endif %}
</div>

{% endblock %}
