{% extends "base.html" %}

{% block title %}Settings - Research Platform{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="page-header">
        <h1>Settings</h1>
        <p class="subtitle">Manage your account and preferences</p>
    </div>

    <!-- Profile Section -->
    <div class="settings-section">
        <h3>Profile</h3>
        <form id="profile-form">
            <div class="form-group">
                <label for="display-name">Display Name</label>
                <input type="text" id="display-name" value="{{ user.display_name or '' }}" placeholder="Your name">
            </div>
            <div class="form-group">
                <label for="bio">Bio</label>
                <textarea id="bio" rows="3" placeholder="Tell us about yourself">{{ user.bio or '' }}</textarea>
            </div>
            <div class="form-group">
                <label for="avatar-url">Avatar URL</label>
                <input type="url" id="avatar-url" value="{{ user.avatar_url or '' }}" placeholder="https://example.com/avatar.png">
            </div>
            <button type="submit" class="btn btn-primary">Save Profile</button>
        </form>
    </div>

    <!-- Appearance Section -->
    <div class="settings-section">
        <h3>Appearance</h3>
        <div class="settings-row">
            <span class="settings-label">Dark Mode</span>
            <input type="checkbox" class="toggle-switch" id="dark-mode-toggle"
                   {% if user.theme == 'dark' %}checked{% endif %}>
        </div>
        <div class="settings-row">
            <span class="settings-label">Language</span>
            <select id="locale-select" style="padding: 4px 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-primary); color: var(--text-primary); font-size: var(--font-size-sm);">
                <option value="ko" {% if user.locale == 'ko' %}selected{% endif %}>Korean</option>
                <option value="en" {% if user.locale == 'en' %}selected{% endif %}>English</option>
            </select>
        </div>
    </div>

    <!-- Security Section -->
    <div class="settings-section">
        <h3>Security</h3>
        <form id="password-form">
            <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" placeholder="Enter current password">
            </div>
            <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" placeholder="Enter new password" minlength="8">
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirm New Password</label>
                <input type="password" id="confirm-password" placeholder="Confirm new password">
            </div>
            <button type="submit" class="btn btn-secondary">Change Password</button>
        </form>
    </div>

    <!-- Account Info -->
    <div class="settings-section">
        <h3>Account</h3>
        <div class="settings-row">
            <span class="settings-label">Email</span>
            <span style="font-size: var(--font-size-sm); color: var(--text-primary);">{{ user.email }}</span>
        </div>
        <div class="settings-row">
            <span class="settings-label">Username</span>
            <span style="font-size: var(--font-size-sm); color: var(--text-primary);">{{ user.username }}</span>
        </div>
        <div class="settings-row">
            <span class="settings-label">Member since</span>
            <span style="font-size: var(--font-size-sm); color: var(--text-tertiary);">{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Profile form
    document.getElementById('profile-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await api.put('/users/me', {
                display_name: document.getElementById('display-name').value,
                bio: document.getElementById('bio').value,
                avatar_url: document.getElementById('avatar-url').value,
            });
            toast.success('Profile updated');
        } catch (err) { toast.error('Failed to update profile'); }
    });

    // Theme toggle
    document.getElementById('dark-mode-toggle')?.addEventListener('change', async (e) => {
        const newTheme = e.target.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        try { await api.put('/users/me', { theme: newTheme }); } catch (err) {}
    });

    // Locale
    document.getElementById('locale-select')?.addEventListener('change', async (e) => {
        try { await api.put('/users/me', { locale: e.target.value }); toast.success('Language updated'); } catch (err) {}
    });

    // Password form
    document.getElementById('password-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const current = document.getElementById('current-password').value;
        const newPw = document.getElementById('new-password').value;
        const confirm = document.getElementById('confirm-password').value;
        if (newPw !== confirm) { toast.error('Passwords do not match'); return; }
        if (newPw.length < 8) { toast.error('Password must be at least 8 characters'); return; }
        try {
            await api.post('/users/me/password', { current_password: current, new_password: newPw });
            toast.success('Password changed');
            document.getElementById('password-form').reset();
        } catch (err) { toast.error('Failed to change password'); }
    });
});
</script>
{% endblock %}
