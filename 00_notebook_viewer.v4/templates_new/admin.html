{% extends "base.html" %} {% block title %}관리자 - Research Platform{% endblock
%} {% block breadcrumb %}
<a href="{{ root_path }}/">홈</a>
<i class="ri-arrow-right-s-line"></i>
<span>관리자</span>
{% endblock %} {% block content %}
<div class="admin-page">
  <h1>관리자 대시보드</h1>

  <div class="admin-stats">
    <div class="stat-card">
      <i class="ri-user-line"></i>
      <div class="stat-value" id="total-users">-</div>
      <div class="stat-label">전체 사용자</div>
    </div>
    <div class="stat-card">
      <i class="ri-building-line"></i>
      <div class="stat-value" id="total-orgs">-</div>
      <div class="stat-label">조직</div>
    </div>
    <div class="stat-card">
      <i class="ri-file-text-line"></i>
      <div class="stat-value" id="total-docs">-</div>
      <div class="stat-label">문서</div>
    </div>
  </div>

  <div class="admin-tabs">
    <button class="tab-btn active" data-tab="users">사용자 관리</button>
    <button class="tab-btn" data-tab="orgs">조직 관리</button>
    <button class="tab-btn" data-tab="audit">감사 로그</button>
  </div>

  <!-- Users Tab -->
  <div class="tab-content active" id="tab-users">
    <div class="table-toolbar">
      <input type="text" placeholder="사용자 검색..." id="user-search" />
      <button class="btn btn-primary" id="add-user-btn">
        <i class="ri-add-line"></i> 사용자 추가
      </button>
    </div>

    <table class="data-table">
      <thead>
        <tr>
          <th>이름</th>
          <th>이메일</th>
          <th>가입일</th>
          <th>상태</th>
          <th>작업</th>
        </tr>
      </thead>
      <tbody id="users-table">
        <!-- Dynamic content -->
      </tbody>
    </table>
  </div>

  <!-- Organizations Tab -->
  <div class="tab-content" id="tab-orgs">
    <table class="data-table">
      <thead>
        <tr>
          <th>이름</th>
          <th>소유자</th>
          <th>멤버 수</th>
          <th>생성일</th>
          <th>작업</th>
        </tr>
      </thead>
      <tbody id="orgs-table"></tbody>
    </table>
  </div>

  <!-- Audit Log Tab -->
  <div class="tab-content" id="tab-audit">
    <table class="data-table">
      <thead>
        <tr>
          <th>시간</th>
          <th>사용자</th>
          <th>작업</th>
          <th>리소스</th>
          <th>IP</th>
        </tr>
      </thead>
      <tbody id="audit-table"></tbody>
    </table>
  </div>
</div>

<style>
  .admin-page {
    max-width: 1400px;
    margin: 0 auto;
  }

  .admin-page h1 {
    margin-bottom: 24px;
  }

  .admin-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .admin-stats .stat-card {
    text-align: center;
    padding: 24px;
  }

  .admin-stats .stat-card i {
    font-size: 2rem;
    color: var(--accent-primary);
    margin-bottom: 12px;
  }

  .admin-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0;
  }

  .tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    position: relative;
  }

  .tab-btn.active {
    color: var(--accent-primary);
  }

  .tab-btn.active::after {
    content: "";
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--accent-primary);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .table-toolbar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .table-toolbar input {
    width: 300px;
    padding: 8px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .data-table th,
  .data-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }

  .data-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    font-size: 0.8125rem;
    color: var(--text-secondary);
  }

  .data-table tr:last-child td {
    border-bottom: none;
  }

  .data-table tr:hover td {
    background: var(--bg-hover);
  }
</style>
{% endblock %} {% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Tabs
    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        btn.classList.add("active");
        document
          .getElementById("tab-" + btn.dataset.tab)
          ?.classList.add("active");

        // Load tab data
        if (btn.dataset.tab === "orgs") loadOrganizations();
        if (btn.dataset.tab === "audit") loadAuditLogs();
      });
    });

    loadUsers();
    loadStats();
  });

  async function loadStats() {
    try {
      const stats = await api.get("/users/admin/stats");
      document.getElementById("total-users").textContent =
        stats.total_users || 0;
      document.getElementById("total-orgs").textContent =
        stats.total_organizations || 0;
      document.getElementById("total-docs").textContent =
        stats.total_documents || 0;
    } catch (error) {
      console.error("Failed to load stats:", error);
      document.getElementById("total-users").textContent = "-";
      document.getElementById("total-orgs").textContent = "-";
      document.getElementById("total-docs").textContent = "-";
    }
  }

  async function loadUsers() {
    const tbody = document.getElementById("users-table");

    try {
      const users = await api.get("/users");
      tbody.innerHTML = users
        .map(
          (user) => `
            <tr>
                <td>${escapeHtml(user.display_name || user.username)}</td>
                <td>${user.email}</td>
                <td>${formatDate(user.created_at)}</td>
                <td><span class="status-badge ${user.is_active !== false ? "active" : "inactive"}">
                    ${user.is_active !== false ? "활성" : "비활성"}
                </span></td>
                <td>
                    <button class="btn btn-ghost btn-sm" onclick="editUser('${user.id}')">편집</button>
                </td>
            </tr>
        `,
        )
        .join("");
    } catch (error) {
      tbody.innerHTML =
        '<tr><td colspan="5">사용자를 불러올 수 없습니다</td></tr>';
    }
  }

  async function loadOrganizations() {
    const tbody = document.getElementById("orgs-table");
    if (!tbody) return;

    try {
      const orgs = await api.get("/organizations");
      tbody.innerHTML = orgs
        .map(
          (org) => `
            <tr>
                <td>${escapeHtml(org.name)}</td>
                <td>${org.owner_email || "-"}</td>
                <td>${org.member_count || 1}</td>
                <td>${formatDate(org.created_at)}</td>
                <td>
                    <button class="btn btn-ghost btn-sm">상세</button>
                </td>
            </tr>
        `,
        )
        .join("");
    } catch (error) {
      tbody.innerHTML =
        '<tr><td colspan="5">조직을 불러올 수 없습니다</td></tr>';
    }
  }

  async function loadAuditLogs() {
    const tbody = document.getElementById("audit-table");
    if (!tbody) return;

    try {
      const logs = await api.get("/users/admin/audit");
      tbody.innerHTML = logs
        .map(
          (log) => `
            <tr>
                <td>${log.timestamp ? new Date(log.timestamp).toLocaleString("ko-KR") : "-"}</td>
                <td>${escapeHtml(log.user_email || "-")}</td>
                <td>${log.action || "-"}</td>
                <td>${escapeHtml(log.resource_name || log.resource_type || "-")}</td>
                <td>${log.ip_address || "-"}</td>
            </tr>
        `,
        )
        .join("");
    } catch (error) {
      tbody.innerHTML =
        '<tr><td colspan="5">감사 로그를 불러올 수 없습니다</td></tr>';
    }
  }

  function editUser(userId) {
    toast.info("사용자 편집 기능은 준비 중입니다");
  }
</script>
{% endblock %}

