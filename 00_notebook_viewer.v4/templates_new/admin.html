{% extends "base.html" %}
{% block title %}Admin - Research Platform{% endblock %}
{% block content %}
<div class="admin-page">
    <div class="page-header"><h1>Admin Dashboard</h1><p class="subtitle">Platform administration</p></div>

    <div class="admin-tabs">
        <button class="admin-tab active" data-tab="overview">Overview</button>
        <button class="admin-tab" data-tab="users">Users</button>
        <button class="admin-tab" data-tab="audit">Audit Log</button>
        <button class="admin-tab" data-tab="feedback">Feedback</button>
    </div>

    <!-- Overview -->
    <div class="admin-tab-content" id="tab-overview">
        <div class="stats-grid" id="admin-stats">
            <div class="stat-card"><div class="stat-icon blue"><i class="ri-user-line"></i></div><div class="stat-value" id="admin-total-users">-</div><div class="stat-label">Total Users</div></div>
            <div class="stat-card"><div class="stat-icon green"><i class="ri-building-line"></i></div><div class="stat-value" id="admin-total-orgs">-</div><div class="stat-label">Organizations</div></div>
            <div class="stat-card"><div class="stat-icon yellow"><i class="ri-file-text-line"></i></div><div class="stat-value" id="admin-total-docs">-</div><div class="stat-label">Documents</div></div>
            <div class="stat-card"><div class="stat-icon purple"><i class="ri-folders-line"></i></div><div class="stat-value" id="admin-total-ws">-</div><div class="stat-label">Workspaces</div></div>
        </div>
    </div>

    <!-- Users -->
    <div class="admin-tab-content" id="tab-users" style="display:none;"><div id="users-list"></div></div>

    <!-- Audit -->
    <div class="admin-tab-content" id="tab-audit" style="display:none;"><div id="audit-list"></div></div>

    <!-- Feedback -->
    <div class="admin-tab-content" id="tab-feedback" style="display:none;"><div id="feedback-list"></div></div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // Tab switching
    document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.style.display = 'none');
            tab.classList.add('active');
            document.getElementById(`tab-${tab.dataset.tab}`).style.display = 'block';
            if (tab.dataset.tab === 'users') loadUsers();
            if (tab.dataset.tab === 'audit') loadAudit();
            if (tab.dataset.tab === 'feedback') loadFeedback();
        });
    });

    // Load stats
    try {
        const stats = await api.get('/users/admin/stats');
        document.getElementById('admin-total-users').textContent = stats.total_users || 0;
        document.getElementById('admin-total-orgs').textContent = stats.total_organizations || 0;
        document.getElementById('admin-total-docs').textContent = stats.total_documents || 0;
        document.getElementById('admin-total-ws').textContent = stats.total_workspaces || 0;
    } catch (e) {}
});

async function loadUsers() {
    const container = document.getElementById('users-list');
    try {
        const users = await api.get('/users?limit=50');
        container.innerHTML = '<div class="doc-list">' + users.map(u => `
            <div class="doc-list-item">
                <span class="doc-icon"><i class="ri-user-line"></i></span>
                <span class="doc-title">${escapeHtml(u.display_name || u.username)} (${escapeHtml(u.email)})</span>
                <span class="doc-date">${u.is_active ? '✅ Active' : '❌ Inactive'}</span>
            </div>
        `).join('') + '</div>';
    } catch (e) { container.innerHTML = '<div class="empty-state"><span>Failed to load users</span></div>'; }
}

async function loadAudit() {
    const container = document.getElementById('audit-list');
    try {
        const logs = await api.get('/users/admin/audit?limit=50');
        const items = logs.items || logs;
        container.innerHTML = '<div class="activity-list">' + items.map(l => `
            <div class="activity-item">
                <div class="activity-icon"><i class="ri-history-line"></i></div>
                <span class="activity-text">${escapeHtml(l.action)} by ${escapeHtml(l.user_email || 'system')} on ${escapeHtml(l.resource_name || l.resource_type || '')}</span>
                <span class="activity-time">${formatDate(l.timestamp)}</span>
            </div>
        `).join('') + '</div>';
    } catch (e) { container.innerHTML = '<div class="empty-state"><span>Failed to load audit logs</span></div>'; }
}

async function loadFeedback() {
    const container = document.getElementById('feedback-list');
    try {
        const feedbacks = await api.get('/feedback/all');
        if (!feedbacks.length) { container.innerHTML = '<div class="empty-state"><span>No feedback yet</span></div>'; return; }
        container.innerHTML = '<div class="doc-list">' + feedbacks.map(f => `
            <div class="doc-list-item" style="flex-direction:column;align-items:flex-start;gap:4px;padding:12px;">
                <div style="display:flex;align-items:center;gap:8px;width:100%;">
                    <span class="card-status">${f.type}</span>
                    <strong style="flex:1;">${escapeHtml(f.title)}</strong>
                    <span class="doc-date">${formatDate(f.created_at)}</span>
                </div>
                <div style="font-size:var(--font-size-sm);color:var(--text-secondary);">${escapeHtml(f.message)}</div>
            </div>
        `).join('') + '</div>';
    } catch (e) { container.innerHTML = '<div class="empty-state"><span>Failed to load feedback</span></div>'; }
}
</script>
{% endblock %}
